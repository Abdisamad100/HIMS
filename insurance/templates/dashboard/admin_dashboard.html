<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Admin — Pro Dashboard</title>

    <!-- Tailwind CDN (prototype) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>tailwind.config = { darkMode: 'class' }</script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* Small visual polish */
        .card {
            border-radius: 1rem;
            box-shadow: 0 8px 30px rgba(2, 6, 23, 0.06);
        }

        .glass {
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(6px);
        }

        .btn {
            transition: all .14s ease-in-out;
        }

        /* subtle scrollbar */
        ::-webkit-scrollbar {
            height: 10px;
            width: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.12);
            border-radius: 10px;
        }
    </style>
</head>

<body class="bg-slate-50 dark:bg-slate-900 text-slate-900 dark:text-slate-100">

    <div class="min-h-screen flex">
        <!-- SIDEBAR -->
        <aside id="sidebar"
            class="w-72 bg-gradient-to-b from-indigo-700 to-sky-700 text-white p-5 flex flex-col gap-6 transition-all">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-lg bg-white/20 flex items-center justify-center">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1.6">
                            <path d="M12 3v18M3 12h18" stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                    </div>
                    <div>
                        <div class="font-semibold text-lg leading-4">HealthInsure</div>
                        <div class="text-xs text-white/80">Admin Portal</div>
                    </div>
                </div>
                <button id="collapseBtn" class="md:hidden text-white/90 btn">✕</button>
            </div>

            <nav class="flex-1">
                <ul id="menu" class="space-y-1">
                    <li><button data-section="home"
                            class="menu-link w-full flex items-center gap-3 px-3 py-2 rounded-md bg-white/10">🏠
                            Dashboard</button></li>

                    <li><button data-section="users"
                            class="menu-link w-full flex items-center gap-3 px-3 py-2 rounded-md hover:bg-white/10">👥
                            Users management</button></li>

                    <!-- <li><button data-section="agents"
                class="menu-link w-full flex items-center gap-3 px-3 py-2 rounded-md hover:bg-white/10">🧑‍💼
                Agents</button></li> -->

                    <li><button data-section="hospitals"
                            class="menu-link w-full flex items-center gap-3 px-3 py-2 rounded-md hover:bg-white/10">🏥
                            Hospitals management</button></li>

                    <!-- <li><button data-section="members"
                class="menu-link w-full flex items-center gap-3 px-3 py-2 rounded-md hover:bg-white/10">🧾
                Members</button></li> -->

                    <!-- <li><button data-section="policyholders"
                class="menu-link w-full flex items-center gap-3 px-3 py-2 rounded-md hover:bg-white/10">📜
                Policy Holders</button></li> -->

                    <li><button data-section="policies"
                            class="menu-link w-full flex items-center gap-3 px-3 py-2 rounded-md hover:bg-white/10">📑
                            Policy management</button></li>

                    <li><button data-section="claims"
                            class="menu-link w-full flex items-center gap-3 px-3 py-2 rounded-md hover:bg-white/10">📂
                            Claims management</button></li>

                    <li><button data-section="reports"
                            class="menu-link w-full flex items-center gap-3 px-3 py-2 rounded-md hover:bg-white/10">📊
                            Reports Management</button></li>

                    <li><button data-section="settings"
                            class="menu-link w-full flex items-center gap-3 px-3 py-2 rounded-md hover:bg-white/10">⚙
                            Settings</button></li>
                </ul>
            </nav>


            <div class="mt-auto space-y-2">
                <button id="addUserBtn" class="w-full rounded-xl py-2 bg-white/20 hover:bg-white/30">＋ Add user</button>
                <button id="themeBtn" class="w-full rounded-xl py-2 bg-white/10">🌙 Theme</button>
            </div>
        </aside>

        <!-- MAIN -->
        <main class="flex-1 p-6 md:p-10 overflow-y-auto">
            <!-- Topbar -->
            <!-- Header -->
            <div class="flex items-center justify-between mb-6">
                <!-- Left side -->
                <div class="flex items-center gap-4">
                    <!-- Sidebar toggle (mobile) -->
                    <button id="menuToggle" class="md:hidden p-2 rounded bg-white/10 hover:bg-white/20">☰</button>

                    <div>
                        <h1 class="text-2xl font-bold">Administrator Dashboard</h1>
                        <p class="text-sm text-slate-500">Overview & management</p>
                    </div>
                </div>

                <!-- Right side -->
                <div class="flex items-center gap-3">
                    <!-- Search -->
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xl font-semibold">Users</h2>
                        <div class="relative">
                            <input id="globalSearch" type="search" placeholder="Search users..."
                                class="px-4 py-2 rounded-2xl border border-slate-200 bg-white shadow-sm focus:ring-2 focus:ring-indigo-200 focus:outline-none" />
                            <button id="searchClear"
                                class="absolute right-3 top-2.5 text-slate-400 hidden hover:text-rose-500">✖</button>
                        </div>
                    </div>


                    <!-- Notifications -->
                    <div class="relative">
                        <button id="notifBtnTop"
                            class="p-2 rounded-xl bg-white/10 hover:bg-white/20 flex items-center justify-center text-lg relative">
                            🔔
                            <span id="notifCountTop"
                                class="absolute -top-1 -right-1 text-xs bg-rose-500 px-1 rounded-full text-white">3</span>
                        </button>
                        <div id="notifDropdown"
                            class="hidden absolute right-0 mt-2 w-56 bg-white dark:bg-slate-800 rounded-lg shadow z-50 p-2">
                            <div class="text-sm font-medium mb-2">Recent Notifications</div>
                            <div id="notifList" class="space-y-1 text-sm text-slate-600 dark:text-slate-300">
                                <div class="px-2 py-1 rounded hover:bg-slate-100 dark:hover:bg-slate-700">✅ Claim #123
                                    approved</div>
                                <div class="px-2 py-1 rounded hover:bg-slate-100 dark:hover:bg-slate-700">⚠️ Pending
                                    hospital registration</div>
                                <div class="px-2 py-1 rounded hover:bg-slate-100 dark:hover:bg-slate-700">💬 2 new
                                    messages</div>
                            </div>
                        </div>
                    </div>

                    <!-- Profile -->
                    <div class="relative">
                        <button id="profileBtn"
                            class="flex items-center gap-2 px-3 py-1 rounded-2xl bg-white/10 hover:bg-white/20">
                            <div
                                class="w-8 h-8 rounded-full bg-gradient-to-br from-indigo-400 to-sky-600 flex items-center justify-center text-white">
                                A
                            </div>
                            <div class="text-left">
                                <div class="text-sm font-medium">Admin</div>
                                <div class="text-xs text-slate-400">Superuser</div>
                            </div>
                        </button>
                        <div id="profileMenu"
                            class="hidden absolute right-0 mt-2 w-48 bg-white dark:bg-slate-800 rounded-lg shadow z-50 p-2">

                            <a href="{% url 'profile' %}"
                                class="block w-full text-left px-3 py-2 rounded hover:bg-slate-100 dark:hover:bg-slate-700">
                                Profile
                            </a>

                            <a href="#"
                                class="block w-full text-left px-3 py-2 rounded hover:bg-slate-100 dark:hover:bg-slate-700">
                                Settings
                            </a>

                            <form method="post" action="{% url 'logout' %}">
                                {% csrf_token %}
                                <button type="submit"
                                    class="w-full text-left px-3 py-2 rounded text-rose-600 hover:bg-slate-100 dark:hover:bg-slate-700">
                                    Logout
                                </button>
                            </form>
                        </div>

                    </div>
                </div>
            </div>


            <!-- CONTENT -->
            <div id="content">
                <!-- HOME / DASHBOARD -->
                <section id="sec-home">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                        <!-- KPI cards -->
                        <div
                            class="card bg-gradient-to-br from-white to-white/80 dark:from-slate-800 dark:to-slate-800 p-5">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-sm text-slate-500 dark:text-slate-400">Total Users</div>
                                    <div id="kpi-users" class="text-2xl font-bold">{{ users_count }}</div>
                                </div>
                                <div class="p-3 rounded-xl bg-indigo-50 text-indigo-700">👥</div>
                            </div>
                        </div>

                        <div class="card p-5 bg-white dark:bg-slate-800">
                            <div>
                                <div class="text-sm text-slate-500 dark:text-slate-400">Pending Claims</div>
                                <div id="kpi-pending" class="text-2xl font-bold">{{ claims_pending }}</div>
                            </div>
                        </div>

                        <div class="card p-5 bg-white dark:bg-slate-800">
                            <div>
                                <div class="text-sm text-slate-500 dark:text-slate-400">Agents</div>
                                <div id="kpi-agents" class="text-2xl font-bold">{{ agents_count }}</div>
                            </div>
                        </div>
                    </div>

                    <!-- Second row of KPIs -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div class="card p-5 bg-white dark:bg-slate-800">
                            <div>
                                <div class="text-sm text-slate-500 dark:text-slate-400">Policies</div>
                                <div id="kpi-policies" class="text-2xl font-bold">{{ policies_count }}</div>

                            </div>
                        </div>

                        <div class="card p-5 bg-white dark:bg-slate-800">
                            <div>
                                <div class="text-sm text-slate-500 dark:text-slate-400">Hospitals</div>
                                <div id="kpi-hospitals" class="text-2xl font-bold">{{ hospitals_count }}</div>
                            </div>
                        </div>
                    </div>

                    <!-- CHARTS: make line chart larger and modern -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <div class="card p-5 bg-white dark:bg-slate-800">
                            <div class="flex items-center justify-between mb-3">
                                <h3 class="font-semibold">Claims Trend — Last 6 months</h3>
                                <div class="text-sm text-slate-400">Snapshot</div>
                            </div>
                            <div class="h-80">
                                <canvas id="chart-line"></canvas>
                            </div>
                        </div>

                        <div class="card p-5 bg-white dark:bg-slate-800">
                            <div class="flex items-center justify-between mb-3">
                                <h3 class="font-semibold">Claims Status</h3>
                                <div class="text-sm text-slate-400">Distribution</div>
                            </div>
                            <div class="h-80 flex flex-col items-center justify-center">
                                <canvas id="chart-donut" style="max-width:320px;"></canvas>
                                <div id="statusLegend" class="mt-4 text-sm text-slate-500"></div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-6 grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Recent Users -->
                        <div class="card p-5 bg-white dark:bg-slate-800">
                            <div class="flex items-center justify-between mb-3">
                                <h3 class="font-semibold">Recent Users</h3>
                                <button class="text-sm text-slate-500"
                                    onclick="setActiveSection('users')">Manage</button>
                            </div>
                            <div id="recentUsers" class="space-y-2 text-sm text-slate-600 dark:text-slate-300">
                                {% for profile in recent_users %}
                                <div class="flex items-center justify-between">
                                    <div>
                                        <div class="font-medium">
                                            {{ profile.user.get_full_name|default:profile.user.username }}
                                        </div>
                                        <div class="text-xs text-slate-500">
                                            {{ profile.get_role_display }} • {{ profile.user.email }}
                                        </div>
                                    </div>
                                    <div class="text-xs text-slate-400">
                                        {{ profile.user.date_joined|date:"Y-m-d" }}
                                    </div>
                                </div>
                                {% empty %}
                                <div class="text-center text-slate-500">No users found</div>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Recent Claims -->
                        <div class="card p-5 bg-white dark:bg-slate-800">
                            <div class="flex items-center justify-between mb-3">
                                <h3 class="font-semibold">Recent Claims</h3>
                                <button class="text-sm text-slate-500"
                                    onclick="setActiveSection('claims')">Manage</button>
                            </div>
                            <div id="recentClaims" class="space-y-2 text-sm text-slate-600 dark:text-slate-300">
                                {% for claim in recent_claims %}
                                <div class="flex items-center justify-between">
                                    <div>
                                        <div class="font-medium">
                                            {{ claim.id }}
                                        </div>
                                        <div class="text-xs text-slate-500">
                                            {{ claim.hospital }}
                                        </div>
                                    </div>
                                    <div class="text-xs text-slate-400">
                                        {{ claim.status }}
                                    </div>
                                </div>
                                {% empty %}
                                <div class="text-center text-slate-500">No claims found</div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>

            </div>
            </section>

            <!-- USERS -->
            <section id="sec-users" class="hidden">
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-6 gap-4 mb-8">

                    <!-- Card -->
                    <div
                        class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm p-5 text-center border border-slate-100 dark:border-slate-700 hover:shadow-md transition-all duration-200">
                        <div class="text-slate-500 text-sm font-medium mb-1">Total Users</div>
                        <div class="text-3xl font-bold text-slate-800 dark:text-white">{{ users_count }}</div>
                    </div>

                    <div
                        class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm p-5 text-center border border-slate-100 dark:border-slate-700 hover:shadow-md transition-all duration-200">
                        <div class="text-slate-500 text-sm font-medium mb-1">Admins</div>
                        <div class="text-3xl font-bold text-indigo-600">{{ admin_count }}</div>
                    </div>

                    <div
                        class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm p-5 text-center border border-slate-100 dark:border-slate-700 hover:shadow-md transition-all duration-200">
                        <div class="text-slate-500 text-sm font-medium mb-1">Agents</div>
                        <div class="text-3xl font-bold text-sky-600">{{ agents_count }}</div>
                    </div>

                    <div
                        class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm p-5 text-center border border-slate-100 dark:border-slate-700 hover:shadow-md transition-all duration-200">
                        <div class="text-slate-500 text-sm font-medium mb-1">Hospitals</div>
                        <div class="text-3xl font-bold text-rose-600">{{ hospitals_count }}</div>
                    </div>

                    <div
                        class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm p-5 text-center border border-slate-100 dark:border-slate-700 hover:shadow-md transition-all duration-200">
                        <div class="text-slate-500 text-sm font-medium mb-1">Claim Officers</div>
                        <div class="text-3xl font-bold text-amber-600">{{ claim_officers_count }}</div>
                    </div>

                    <div
                        class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm p-5 text-center border border-slate-100 dark:border-slate-700 hover:shadow-md transition-all duration-200">
                        <div class="text-slate-500 text-sm font-medium mb-1">Customers</div>
                        <div class="text-3xl font-bold text-emerald-600">{{ customers_count }}</div>
                    </div>

                </div>
                <!-- Header -->
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-semibold">Users</h2>
                    <div class="flex items-center gap-2">
                        <!-- Role Filter -->
                        <select id="roleFilter"
                            class="px-4 py-2 rounded-2xl border border-slate-200 bg-white shadow-sm focus:ring-2 focus:ring-indigo-200 focus:outline-none">
                            <option value="all">All roles</option>
                            <option value="admin">Admin</option>
                            <option value="agent">Agent</option>
                            <option value="hospital">Hospital</option>
                            <option value="claim officer">Claim Officer</option>
                            <option value="customer">Customer</option>
                        </select>

                        <!-- Add Button -->
                        <a href="{% url 'register_user' %}"
                            class="px-4 py-2 rounded-2xl bg-indigo-600 text-white hover:bg-indigo-700 shadow-sm transition">
                            ＋ Add
                        </a>
                    </div>
                </div>

                <!-- Table -->
                <div class="card overflow-x-auto">
                    <table class="min-w-full text-sm">
                        <thead class="bg-slate-100 dark:bg-slate-800/50">
                            <tr>
                                <th class="px-4 py-3 text-left">Name</th>
                                <th class="px-4 py-3 text-left">Role</th>
                                <th class="px-4 py-3 text-left">Email</th>
                                <th class="px-4 py-3 text-left">Status</th>
                                <th class="px-4 py-3 text-left">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTbody" class="divide-y">
                            {% for profile in users %}
                            <tr class="hover:bg-slate-50 dark:hover:bg-slate-800/60">
                                <td class="px-4 py-3">{{ profile.user.get_full_name|default:profile.user.username }}
                                </td>
                                <td class="px-4 py-3">
                                    <span class="px-2 py-1 rounded text-xs bg-slate-100 dark:bg-slate-700">
                                        {{ profile.get_role_display }}
                                    </span>
                                </td>
                                <td class="px-4 py-3">{{ profile.user.email }}</td>
                                <td class="px-4 py-3">
                                    <span
                                        class="px-2 py-1 rounded text-xs {% if profile.user.is_active %}bg-emerald-100 text-emerald-800{% else %}bg-amber-100 text-amber-800{% endif %}">
                                        {% if profile.user.is_active %}Active{% else %}Inactive{% endif %}
                                    </span>
                                </td>
                                <td class="px-4 py-3">
                                    <!-- Edit -->
                                    <a href="{% url 'edit_user' profile.id %}" class="text-sky-600 mr-3 hover:underline"
                                        title="Edit">✎</a>

                                    <!-- Toggle status via JS -->
                                    <button onclick="toggleUserStatus({{ profile.id }})"
                                        class="text-rose-600 hover:underline" title="Suspend or Activate">
                                        {% if profile.user.is_active %}⛔{% else %}✅{% endif %}
                                    </button>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="px-4 py-3 text-center text-slate-500">No users found</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Footer -->
                <div class="mt-4 flex items-center justify-between text-sm text-slate-500">
                    <div id="usersSummary">Showing {{ users|length }} users</div>
                    <div class="flex gap-2">
                        <button id="usersPrev" class="px-3 py-1 rounded bg-white/10">Prev</button>
                        <button id="usersNext" class="px-3 py-1 rounded bg-white/10">Next</button>
                    </div>
                </div>

                <!-- Script -->
                <script>
                    document.addEventListener('DOMContentLoaded', () => {
                        const roleFilter = document.getElementById('roleFilter');
                        const searchInput = document.getElementById('globalSearch');
                        const searchClear = document.getElementById('searchClear');
                        const usersTbody = document.getElementById('usersTbody');
                        const usersSummary = document.getElementById('usersSummary');

                        // ========= CSRF Helper =========
                        function getCookie(name) {
                            let cookieValue = null;
                            if (document.cookie && document.cookie !== '') {
                                const cookies = document.cookie.split(';');
                                for (let cookie of cookies) {
                                    cookie = cookie.trim();
                                    if (cookie.startsWith(name + '=')) {
                                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                                        break;
                                    }
                                }
                            }
                            return cookieValue;
                        }

                        // ========= Toggle User Status =========
                        window.toggleUserStatus = function (id) {
                            if (!confirm("Are you sure you want to toggle this user's status?")) return;

                            fetch(`/toggle-user-status/${id}/`, {
                                method: 'POST',
                                headers: {
                                    'X-CSRFToken': getCookie('csrftoken'),
                                    'X-Requested-With': 'XMLHttpRequest'
                                }
                            })
                                .then(res => {
                                    if (!res.ok) throw new Error("Failed to toggle status");
                                    return res.text();
                                })
                                .then(() => fetchUsers())  // refresh users dynamically
                                .catch(err => alert(err.message));
                        };

                        // ========= Fetch Filtered Users =========
                        function fetchUsers() {
                            const role = roleFilter ? roleFilter.value : 'all';
                            const search = searchInput ? searchInput.value.trim() : '';

                            const url = `/filter-users/?role=${encodeURIComponent(role)}&search=${encodeURIComponent(search)}`;

                            fetch(url)
                                .then(res => res.json())
                                .then(data => {
                                    if (data.users) {
                                        renderUsers(data.users);
                                        if (usersSummary) {
                                            usersSummary.textContent = `Showing ${data.users.length} users`;
                                        }
                                    }
                                })
                                .catch(err => console.error('Error fetching users:', err));
                        }

                        // ========= Render Table =========
                        function renderUsers(users) {
                            usersTbody.innerHTML = '';

                            if (users.length === 0) {
                                usersTbody.innerHTML = `
                        <tr>
                            <td colspan="5" class="px-4 py-3 text-center text-slate-500">No users found</td>
                        </tr>`;
                                return;
                            }

                            users.forEach(u => {
                                const statusBadge = u.is_active
                                    ? '<span class="px-2 py-1 rounded text-xs bg-emerald-100 text-emerald-800">Active</span>'
                                    : '<span class="px-2 py-1 rounded text-xs bg-amber-100 text-amber-800">Inactive</span>';

                                usersTbody.innerHTML += `
                        <tr class="hover:bg-slate-50 dark:hover:bg-slate-800/60">
                            <td class="px-4 py-3">${u.name}</td>
                            <td class="px-4 py-3">
                                <span class="px-2 py-1 rounded text-xs bg-slate-100 dark:bg-slate-700">${u.role}</span>
                            </td>
                            <td class="px-4 py-3">${u.email}</td>
                            <td class="px-4 py-3">${statusBadge}</td>
                            <td class="px-4 py-3">
                                <a href="/edit-user/${u.id}/" class="text-sky-600 mr-3 hover:underline" title="Edit">✎</a>
                                <button onclick="toggleUserStatus(${u.id})"
                                    class="text-rose-600 hover:underline"
                                    title="Suspend or Activate">
                                    ${u.is_active ? '⛔' : '✅'}
                                </button>
                            </td>
                        </tr>`;
                            });
                        }

                        // ========= Filter & Search Handlers =========
                        if (roleFilter) roleFilter.addEventListener('change', fetchUsers);
                        if (searchInput) {
                            searchInput.addEventListener('input', () => {
                                searchClear.classList.toggle('hidden', !searchInput.value);
                                fetchUsers();
                            });
                        }
                        if (searchClear) {
                            searchClear.addEventListener('click', () => {
                                searchInput.value = '';
                                searchClear.classList.add('hidden');
                                fetchUsers();
                            });
                        }

                        // Initial load
                        fetchUsers();
                    });
                </script>
            </section>



            <!-- AGENTS -->
            <!-- AGENTS -->
            <section id="sec-agents" class="hidden">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-semibold">Agents</h2>
                    <div class="flex items-center gap-2">
                        <a href="{% url 'register_user' %}?role=agent"
                            class="px-3 py-2 rounded bg-indigo-600 text-white hover:bg-indigo-700">＋ Add Agent</a>
                    </div>
                </div>

                <div class="card overflow-x-auto">
                    <table class="min-w-full text-sm">
                        <thead class="bg-slate-100 dark:bg-slate-800/50">
                            <tr>
                                <th class="px-4 py-3 text-left">Name</th>
                                <th class="px-4 py-3 text-left">Email</th>
                                <th class="px-4 py-3 text-left">Phone</th>
                                <th class="px-4 py-3 text-left">Status</th>
                                <th class="px-4 py-3 text-left">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="agentsTbody" class="divide-y">
                            {% for profile in agent_list %}
                            <tr class="hover:bg-slate-50 dark:hover:bg-slate-800/60">
                                <td class="px-4 py-3">
                                    {{ profile.user.username }}
                                </td>
                                <td class="px-4 py-3">{{ profile.user.email }}</td>
                                <td class="px-4 py-3">{{ profile.phone_number|default:"—" }}</td>
                                <td class="px-4 py-3">
                                    <span
                                        class="px-2 py-1 rounded text-xs {% if profile.user.is_active %}bg-emerald-100 text-emerald-800{% else %}bg-amber-100 text-amber-800{% endif %}">
                                        {% if profile.user.is_active %}Active{% else %}Inactive{% endif %}
                                    </span>
                                </td>
                                <td class="px-4 py-3">
                                    <a href="{% url 'edit_agent' profile.id %}"
                                        class="text-sky-600 mr-3 hover:underline" title="Edit">✎</a>
                                    <form action="{% url 'toggle_agent_status' profile.id %}" method="post"
                                        class="inline">
                                        {% csrf_token %}
                                        <button type="submit" class="text-rose-600 hover:underline" title="Suspend">
                                            {% if profile.user.is_active %}⛔{% else %}✅{% endif %}
                                        </button>
                                    </form>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="px-4 py-3 text-center text-slate-500">
                                    No agents found
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>

                    </table>
                </div>

                <div class="mt-4 flex items-center justify-between text-sm text-slate-500">
                    <div>Showing {{ agent_list|length }} agents</div>
                    <div class="flex gap-2">
                        <button id="agentsPrev" class="px-3 py-1 rounded bg-white/10">Prev</button>
                        <button id="agentsNext" class="px-3 py-1 rounded bg-white/10">Next</button>
                    </div>
                </div>
            </section>

            <!-- policy Section -->
            <section id="sec-policies" class="hidden">
                <!-- Header -->
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-semibold">Policy Management</h2>
                    <a href="{% url 'create_policy' %}"
                        class="px-3 py-2 rounded bg-indigo-600 text-white hover:bg-indigo-700">
                        ＋ Add Policy
                    </a>
                </div>

                <!-- Summary Cards -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <div class="p-4 bg-white dark:bg-slate-800 rounded-2xl shadow">
                        <div class="text-sm text-slate-500">Total Policies</div>
                        <div class="text-2xl font-semibold">{{ total_policies }}</div>
                    </div>

                    <div class="p-4 bg-white dark:bg-slate-800 rounded-2xl shadow">
                        <div class="text-sm text-slate-500">Active Policies</div>
                        <div class="text-2xl font-semibold">{{ active_policies }}</div>
                    </div>

                    <div class="p-4 bg-white dark:bg-slate-800 rounded-2xl shadow">
                        <div class="text-sm text-slate-500">Total Premium Expected</div>
                        <div class="text-2xl font-semibold">KSh {{ total_premium }}</div>
                    </div>

                    <div class="p-4 bg-white dark:bg-slate-800 rounded-2xl shadow">
                        <div class="text-sm text-slate-500">Expired Policies</div>
                        <div class="text-2xl font-semibold">{{ expired_policies }}</div>
                    </div>
                </div>

                <!-- Policy Table -->
                <div class="card overflow-x-auto">
                    <table class="min-w-full text-sm">
                        <thead class="bg-slate-100 dark:bg-slate-800/50">
                            <tr>
                                <th class="px-4 py-3 text-left">Policy Number</th>
                                <th class="px-4 py-3 text-left">Name</th>
                                <th class="px-4 py-3 text-left">Premium</th>
                                <th class="px-4 py-3 text-left">Status</th>
                                <th class="px-4 py-3 text-left">Start Date</th>
                                <th class="px-4 py-3 text-left">End Date</th>
                                <th class="px-4 py-3 text-left">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="policiesTbody" class="divide-y">
                            {% for policy in policies %}
                            <tr class="hover:bg-slate-50 dark:hover:bg-slate-800/60">
                                <td class="px-4 py-3 font-medium">{{ policy.policy_number }}</td>
                                <td class="px-4 py-3">{{ policy.name }}</td>
                                <td class="px-4 py-3">{{ policy.premium }}</td>
                                <td class="px-4 py-3">
                                    <span class="px-2 py-1 rounded text-xs
                            {% if policy.status == 'active' %}
                                bg-emerald-100 text-emerald-800
                            {% elif policy.status == 'expired' %}
                                bg-rose-100 text-rose-800
                            {% else %}
                                bg-amber-100 text-amber-800
                            {% endif %}">
                                        {{ policy.status|capfirst }}
                                    </span>
                                </td>
                                <td class="px-4 py-3">{{ policy.start_date|date:"M d, Y" }}</td>
                                <td class="px-4 py-3">{{ policy.end_date|date:"M d, Y" }}</td>
                                <td class="px-4 py-3">
                                    <a href="{% url 'edit_policy' policy.id %}"
                                        class="text-sky-600 mr-3 hover:underline" title="Edit">✎</a>
                                    <form action="{% url 'delete_policy' policy.id %}" method="post" class="inline">
                                        {% csrf_token %}
                                        <button type="submit" class="text-rose-600 hover:underline"
                                            title="Delete">🗑</button>
                                    </form>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="7" class="px-4 py-3 text-center text-slate-500">
                                    No policies found
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Pagination Footer -->
                <div class="mt-4 flex items-center justify-between text-sm text-slate-500">
                    <div>Showing {{ policies|length }} policies</div>
                    <div class="flex gap-2">
                        <button id="policiesPrev" class="px-3 py-1 rounded bg-white/10">Prev</button>
                        <button id="policiesNext" class="px-3 py-1 rounded bg-white/10">Next</button>
                    </div>
                </div>
            </section>

            <!-- 🏥 Hospitals Section -->
            <section id="sec-hospitals" class="hidden">
                <!-- Header -->
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-6 gap-3">
                    <div>
                        <h2 class="text-2xl font-semibold text-slate-800 dark:text-white">Hospitals</h2>
                        <p class="text-slate-500 text-sm">Manage registered healthcare providers</p>
                    </div>

                    <div class="flex gap-2">
                        <!-- Search -->
                        <input id="hospitalSearch" type="text" placeholder="Search hospitals..."
                            class="border border-slate-300 dark:border-slate-700 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 dark:bg-slate-900 dark:text-white transition w-48 sm:w-64" />

                        <!-- Add Button -->
                        <a href="{% url 'register_user' %}"
                            class="inline-flex items-center gap-1 bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition text-sm font-medium shadow-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 4v16m8-8H4" />
                            </svg>
                            Add Hospital
                        </a>
                    </div>
                </div>

                <!-- Table -->
                <div
                    class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 overflow-hidden">
                    <table class="w-full text-sm">
                        <thead class="bg-slate-50 dark:bg-slate-700/40">
                            <tr class="text-left text-slate-600 dark:text-slate-300">
                                <th class="py-3 px-4 font-medium">#</th>
                                <th class="py-3 px-4 font-medium">Hospital Name</th>
                                <th class="py-3 px-4 font-medium">Email</th>
                                <th class="py-3 px-4 font-medium">Location</th>
                                <th class="py-3 px-4 font-medium">Status</th>
                                <th class="py-3 px-4 font-medium text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="hospitalTableBody" class="divide-y divide-slate-100 dark:divide-slate-700">
                            {% for hospital in hospital_list %}
                            <tr class="hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-colors">
                                <td class="py-3 px-4 text-slate-500">{{ forloop.counter }}</td>
                                <td class="py-3 px-4 font-medium text-slate-800 dark:text-slate-100">
                                    {{ hospital.user.get_full_name|default:hospital.user.username }}
                                </td>
                                <td class="py-3 px-4 text-slate-600 dark:text-slate-300">{{ hospital.user.email }}</td>
                                <td class="py-3 px-4 text-slate-600 dark:text-slate-300">{{
                                    hospital.address|default:"N/A" }}</td>
                                <td class="py-3 px-4">
                                    {% if hospital.user.is_active %}
                                    <span
                                        class="px-2 py-1 text-xs font-medium bg-emerald-100 text-emerald-700 rounded-full">Active</span>
                                    {% else %}
                                    <span
                                        class="px-2 py-1 text-xs font-medium bg-rose-100 text-rose-700 rounded-full">Inactive</span>
                                    {% endif %}
                                </td>
                                <td class="py-3 px-4 text-right">
                                    <div class="inline-flex items-center gap-3">
                                        <!-- Edit -->
                                        <a href="{% url 'edit_hospital' hospital.id %}"
                                            class="text-indigo-600 hover:text-indigo-800 dark:hover:text-indigo-400 font-medium text-sm">Edit</a>

                                        <!-- Suspend / Activate -->
                                        <form action="{% url 'toggle_hospital_status' hospital.id %}" method="post"
                                            class="inline">
                                            {% csrf_token %}
                                            {% if hospital.user.is_active %}
                                            <button type="submit"
                                                class="text-rose-600 hover:text-rose-800 dark:hover:text-rose-400 font-medium text-sm">Suspend</button>
                                            {% else %}
                                            <button type="submit"
                                                class="text-emerald-600 hover:text-emerald-800 dark:hover:text-emerald-400 font-medium text-sm">Activate</button>
                                            {% endif %}
                                        </form>
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="6" class="text-center py-6 text-slate-500 dark:text-slate-400">No hospitals
                                    found.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Search Script -->
                <script>
                    document.addEventListener('DOMContentLoaded', () => {
                        const searchInput = document.getElementById('hospitalSearch');
                        const tableBody = document.getElementById('hospitalTableBody');

                        searchInput.addEventListener('input', () => {
                            const term = searchInput.value.toLowerCase();
                            tableBody.querySelectorAll('tr').forEach(row => {
                                const name = row.cells[1]?.textContent.toLowerCase() || '';
                                const email = row.cells[2]?.textContent.toLowerCase() || '';
                                const address = row.cells[3]?.textContent.toLowerCase() || '';
                                row.style.display = name.includes(term) || email.includes(term) || address.includes(term) ? '' : 'none';
                            });
                        });
                    });
                </script>
            </section>


            <!-- CLAIMS -->
            <section id="sec-claims" class="hidden">
                <div class="grid grid-cols-1 sm:grid-cols-4 gap-4 mb-6">
                    <!-- Pending -->
                    <div
                        class="bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-xl p-4 shadow-sm">
                        <div class="text-amber-600 text-sm font-semibold">Pending</div>
                        <div class="text-2xl font-bold mt-1">{{ stats.Pending }}</div>
                    </div>

                    <!-- Approved -->
                    <div
                        class="bg-emerald-50 dark:bg-emerald-900/20 border border-emerald-200 dark:border-emerald-800 rounded-xl p-4 shadow-sm">
                        <div class="text-emerald-600 text-sm font-semibold">Approved</div>
                        <div class="text-2xl font-bold mt-1">{{ stats.Approved }}</div>
                    </div>

                    <!-- Rejected -->
                    <div
                        class="bg-rose-50 dark:bg-rose-900/20 border border-rose-200 dark:border-rose-800 rounded-xl p-4 shadow-sm">
                        <div class="text-rose-600 text-sm font-semibold">Rejected</div>
                        <div class="text-2xl font-bold mt-1">{{ stats.Rejected }}</div>
                    </div>

                    <!-- Reimbursed -->
                    <div
                        class="bg-purple-50 dark:bg-purple-900/20 border border-purple-200 dark:border-purple-800 rounded-xl p-4 shadow-sm">
                        <div class="text-purple-600 text-sm font-semibold">Reimbursed</div>
                        <div class="text-2xl font-bold mt-1">{{ stats.Reimbursed }}</div>
                    </div>


                </div>

                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-semibold">Claims</h2>
                    <div class="text-sm text-slate-500">Manage claim approvals</div>
                </div>

                <div class="card overflow-x-auto">
                    <table class="min-w-full text-sm">
                        <thead class="bg-slate-100 dark:bg-slate-800/50">
                            <tr>
                                <th class="px-4 py-3 text-left">#</th>
                                <th class="px-4 py-3 text-left">Member</th>
                                <th class="px-4 py-3 text-left">Hospital</th>
                                <th class="px-4 py-3 text-left">Amount</th>
                                <th class="px-4 py-3 text-left">Date</th>
                                <th class="px-4 py-3 text-left">Status</th>
                                <th class="px-4 py-3 text-left">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="claimsTbody" class="divide-y">
                            {% for claim in claims_list %}
                            <tr class="hover:bg-slate-50 dark:hover:bg-slate-800/60">
                                <td class="px-4 py-3">{{ claim.id }}</td>
                                <td class="px-4 py-3">
                                    {% if claim.member_policy %}
                                    {% if claim.member_policy.member.user.get_full_name %}
                                    {{ claim.member_policy.member.user.get_full_name }}
                                    {% else %}
                                    {{ claim.member_policy.member.user.username }}
                                    {% endif %}
                                    {% else %}
                                    <span class="text-gray-500 italic">No member linked</span>
                                    {% endif %}
                                </td>

                                <td class="px-4 py-3">{{ claim.hospital.username|default:'-' }}</td>
                                <td class="px-4 py-3">KES {{ claim.amount|floatformat:2 }}</td>
                                <td class="px-4 py-3">{{ claim.date_of_service|date:"Y-m-d" }}</td>
                                <td class="px-4 py-3">
                                    <span class="px-2 py-1 rounded text-xs
                            {% if claim.status == 'Approved' %}bg-emerald-100 text-emerald-800
                            {% elif claim.status == 'Pending' %}bg-amber-100 text-amber-800
                            {% elif claim.status == 'Rejected' %}bg-rose-100 text-rose-800
                            {% elif claim.status == 'Forwarded' %}bg-blue-100 text-blue-800
                            {% elif claim.status == 'Reimbursed' %}bg-purple-100 text-purple-800
                            {% endif %}">
                                        {{ claim.status }}
                                    </span>
                                </td>
                                <td class="px-4 py-3 space-x-2">
                                    <button class="text-sky-600" onclick="viewClaim({{ claim.id }})">🔎</button>

                                    {% if claim.status in 'Pending,Forwarded' %}
                                    <button class="text-emerald-600" onclick="approveClaim({{ claim.id }})">✔</button>
                                    <button class="text-rose-600" onclick="rejectClaim({{ claim.id }})">✖</button>
                                    <button class="text-yellow-600" onclick="forwardClaim({{ claim.id }})">➡</button>
                                    {% endif %}

                                    {% if claim.status == 'Approved' and role == 'admin' %}
                                    <button class="text-purple-600" onclick="reimburseClaim({{ claim.id }})">💰</button>
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="7" class="px-4 py-3 text-center text-slate-500">No claims found</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </section>


            <!-- REPORTS -->
            <section id="sec-reports" class="hidden">
                <h2 class="text-xl font-semibold mb-4">Reports</h2>

                <div class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow">
                    <div class="flex gap-2 mb-4">
                        <a href="{% url 'export_users_csv' %}"
                            class="px-3 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 transition">
                            Export Users CSV
                        </a>

                        <a href="{% url 'export_claims_csv' %}"
                            class="px-3 py-2 bg-sky-600 text-white rounded hover:bg-sky-700 transition">
                            Export Claims CSV
                        </a>
                    </div>

                    <p class="text-sm text-slate-600 dark:text-slate-400">
                        Click a button to download reports in CSV format.
                    </p>
                </div>
            </section>

            <!-- SETTINGS -->
            <section id="sec-settings" class="hidden">
                <h2 class="text-xl font-semibold mb-4">Settings</h2>
                <div class="card p-4">
                    <label class="block text-sm text-slate-600 mb-2">Site title</label>
                    <input id="siteTitle" class="border rounded px-3 py-2 w-full mb-3" value="HealthInsure Admin" />
                    <div class="text-sm text-slate-500">App settings (placeholder)</div>
                </div>
            </section>
    </div>
    </main>
    </div>

    <!-- MODALS (Add/Edit / Confirm) -->
    <div id="modalRoot" class="fixed inset-0 hidden items-center justify-center z-50 bg-black/50 p-4">
        <div id="modalCard" class="bg-white dark:bg-slate-800 rounded-2xl p-6 w-full max-w-2xl"></div>
    </div>

    <script>
        /**************************************************************************
         * Demo data + state
         ***************************************************************************/
        const ROLES = ['Administrator', 'Agent', 'Hospital', 'Claims Officer', 'Report Officer', 'Tax Inspector', 'Client'];

        // ui state
        let activeSection = 'home';
        let usersPage = 1;
        let usersPerPage = 8;
        let usersFilterRole = 'all';
        let chartLine, chartDonut;

        /**************************************************************************
         * small helpers
         ***************************************************************************/
        const $ = sel => document.querySelector(sel);
        const $$ = sel => Array.from(document.querySelectorAll(sel));
        function formatKES(n) { return n.toLocaleString('en-KE'); }
        function openModal(html) { $('#modalCard').innerHTML = html; $('#modalRoot').classList.remove('hidden'); document.body.style.overflow = 'hidden'; }
        function closeModal() { $('#modalRoot').classList.add('hidden'); $('#modalCard').innerHTML = ''; document.body.style.overflow = ''; }

        /**************************************************************************
         * Sidebar / nav wiring
         ***************************************************************************/
        function setActiveSection(name) {
            activeSection = name;
            ['home', 'users', 'agents', 'hospitals', 'claims', 'policies', 'reports', 'settings'].forEach(s => {
                const el = document.getElementById('sec-' + s);
                if (el) el.classList.toggle('hidden', s !== name);
            });
            $$('.menu-link').forEach(btn => btn.classList.toggle('bg-white/10', btn.dataset.section === name));
        }


        $$('.menu-link').forEach(b => b.addEventListener('click', () => setActiveSection(b.dataset.section)));
        $('#menuToggle')?.addEventListener('click', () => $('#sidebar').classList.toggle('hidden'));
        $('#themeBtn')?.addEventListener('click', () => document.documentElement.classList.toggle('dark'));
        $('#profileBtn')?.addEventListener('click', () => $('#profileMenu').classList.toggle('hidden'));
        $('#addUserBtn')?.addEventListener('click', () => openAddUserForm());
        $('#openAdd')?.addEventListener('click', () => openAddUserForm());

        /* search */
        /* search */
        const searchInput = $('#globalSearch');
        const searchClear = $('#searchClear');
        const usersTbody = $('#usersTbody');
        const usersSummary = $('#usersSummary');
        const roleFilter = $('#roleFilter');

        // Fetch users (role + search)
        function fetchUsers() {
            const role = roleFilter ? roleFilter.value : "all";
            const search = searchInput ? searchInput.value.trim() : "";

            const params = new URLSearchParams({ role, search });
            fetch(`/filter-users/?${params.toString()}`)
                .then(res => res.json())
                .then(data => {
                    if (data.users) {
                        renderUsers(data.users);
                        if (usersSummary)
                            usersSummary.textContent = `Showing ${data.users.length} users`;
                    }
                })
                .catch(err => console.error("Error fetching users:", err));
        }

        // Render users into table
        function renderUsers(users) {
            if (!usersTbody) return;
            usersTbody.innerHTML = '';

            if (users.length === 0) {
                usersTbody.innerHTML = `
            <tr>
                <td colspan="5" class="px-4 py-3 text-center text-slate-500">
                    No users found
                </td>
            </tr>`;
                return;
            }

            users.forEach(u => {
                const statusBadge = u.is_active
                    ? '<span class="px-2 py-1 rounded text-xs bg-emerald-100 text-emerald-800">Active</span>'
                    : '<span class="px-2 py-1 rounded text-xs bg-amber-100 text-amber-800">Inactive</span>';

                usersTbody.innerHTML += `
            <tr class="hover:bg-slate-50 dark:hover:bg-slate-800/60">
                <td class="px-4 py-3">${u.name}</td>
                <td class="px-4 py-3">
                    <span class="px-2 py-1 rounded text-xs bg-slate-100 dark:bg-slate-700">${u.role}</span>
                </td>
                <td class="px-4 py-3">${u.email}</td>
                <td class="px-4 py-3">${statusBadge}</td>
                <td class="px-4 py-3">
                    <a href="/edit-user/${u.id}/" class="text-sky-600 mr-3 hover:underline" title="Edit">✎</a>
                    <form action="/toggle-user-status/${u.id}/" method="post" class="inline">
                        <button type="submit" class="text-rose-600 hover:underline" title="Suspend or Activate">
                            ${u.is_active ? '⛔' : '✅'}
                        </button>
                    </form>
                </td>
            </tr>`;
            });
        }

        // --- Live search ---
        searchInput?.addEventListener("input", (e) => {
            const v = e.target.value.trim();
            searchClear.classList.toggle("hidden", !v);
            fetchUsers();
        });

        // --- Clear button ---
        searchClear?.addEventListener("click", () => {
            searchInput.value = '';
            searchClear.classList.add('hidden');
            fetchUsers();
        });

        // --- Role filter ---
        roleFilter?.addEventListener("change", fetchUsers);

        // --- Initial load ---
        fetchUsers();

        /**************************************************************************
         * Home / KPIs / Charts
         ***************************************************************************/
        function createCharts() {
            // Wait for the DOM elements to exist
            const lineEl = document.getElementById('chart-line');
            const donutEl = document.getElementById('chart-donut');

            if (!lineEl || !donutEl) return;

            // ---------------------------
            // Line chart (Claims trend)
            // ---------------------------
            const lineCtx = lineEl.getContext('2d');
            const gradient = lineCtx.createLinearGradient(0, 0, 0, 300);
            gradient.addColorStop(0, 'rgba(14,165,233,0.16)');
            gradient.addColorStop(1, 'rgba(14,165,233,0.02)');

            chartLine = new Chart(lineCtx, {
                type: 'line',
                data: {
                    labels: ['Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep'],
                    datasets: [{
                        label: 'Claims (KES)',
                        data: [12000, 18000, 15000, 21000, 24000, 20000],
                        borderColor: '#0ea5e9',
                        backgroundColor: gradient,
                        tension: 0.32,
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { display: false }, ticks: { color: getComputedStyle(document.documentElement).color } },
                        y: { grid: { color: 'rgba(15,23,42,0.04)' }, ticks: { callback: v => 'KES ' + Number(v).toLocaleString() } }
                    }
                }
            });

            // ---------------------------
            // Donut chart (Claims status)
            // ---------------------------
            // Parse Django template values safely
            const approved = parseInt("{{ claims_approved|default:'0' }}", 10) || 0;
            const pending = parseInt("{{ claims_pending|default:'0' }}", 10) || 0;
            const rejected = parseInt("{{ claims_rejected|default:'0' }}", 10) || 0;

            const statusCounts = [approved, pending, rejected];

            const donutCtx = donutEl.getContext('2d');
            chartDonut = new Chart(donutCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Approved', 'Pending', 'Rejected'],
                    datasets: [{
                        data: statusCounts,
                        backgroundColor: ['#10b981', '#f59e0b', '#ef4444'],
                        hoverOffset: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } }
                }
            });

            // ---------------------------
            // Refresh legend
            // ---------------------------
            refreshStatusLegend();
        }

        function refreshStatusLegend() {
            const legend = document.getElementById('statusLegend');
            if (!legend || !chartDonut) return;

            legend.innerHTML = '';
            const labels = chartDonut.data.labels;
            const data = chartDonut.data.datasets[0].data;
            const colors = chartDonut.data.datasets[0].backgroundColor;

            labels.forEach((label, i) => {
                const row = document.createElement('div');
                row.className = 'flex items-center gap-2 mb-1';
                row.innerHTML = `<span class="w-3 h-3 rounded" style="background:${colors[i]}"></span>
                         <div class="text-sm">${label} — ${data[i]}</div>`;
                legend.appendChild(row);
            });
        }

        // Call after DOM is loaded
        document.addEventListener('DOMContentLoaded', createCharts);


        /**************************************************************************
         * Users table (filter, pagination, add/edit)
         ***************************************************************************/
        // Add user flow - modal with role selection
        function openAddUserForm() {
            openModal(`
      <div>
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-semibold">Add New User</h3>
        </div>
        <form id="formAddUser" class="grid grid-cols-1 gap-3">
          <input id="u_name" class="border px-3 py-2 rounded" placeholder="Full name" required />
          <input id="u_email" class="border px-3 py-2 rounded" placeholder="Email" type="email" required />
          <select id="u_role" class="border px-3 py-2 rounded">${ROLES.map(r => `<option>${r}</option>`).join('')}</select>
          <select id="u_status" class="border px-3 py-2 rounded"><option>Active</option><option>Pending</option></select>
          <div class="flex items-center justify-end gap-2 mt-2">
            <button type="button" onclick="closeModal()" class="px-3 py-2 rounded bg-slate-200">Cancel</button>
            <button class="px-3 py-2 rounded bg-indigo-600 text-white">Create</button>
          </div>
        </form>
      </div>
    `);

            document.getElementById('formAddUser').addEventListener('submit', function (e) {
                e.preventDefault();
                const name = $('#u_name').value.trim();
                const email = $('#u_email').value.trim();
                const role = $('#u_role').value;
                const status = $('#u_status').value;
                if (!name || !email) { alert('Name & email required'); return; }

                // Submit form via AJAX or redirect
                alert('User creation would be handled by Django backend');
                closeModal();
            });
        }

        function openEditUser(id) {
            // This would fetch user data from Django backend via AJAX
            alert('Edit user functionality would fetch data from Django backend');
        }

        function confirmSuspend(id) {
            openModal(`
      <div>
        <h3 class="text-lg font-semibold mb-2">Suspend user?</h3>
        <p class="text-sm text-slate-500 mb-4">This will mark the user as Suspended (you can reactivate later).</p>
        <div class="flex justify-end gap-2">
          <button onclick="closeModal()" class="px-3 py-2 rounded bg-slate-200">Cancel</button>
          <button class="px-3 py-2 rounded bg-rose-600 text-white" onclick="suspendUser(${id})">Suspend</button>
        </div>
      </div>
    `);
        }

        function suspendUser(id) {
            alert('User suspension would be handled by Django backend');
            closeModal();
        }

        /**************************************************************************
         * Claims table + actions
         ***************************************************************************/
        /**************************************************************************
     * Claims actions
     ***************************************************************************/

        // View claim details
        function viewClaim(id) {
            window.location.href = `/claims/${id}/`; // Go to claim detail page
        }

        // Approve claim
        function approveClaim(id) {
            if (!confirm('Approve this claim?')) return;
            fetch(`/claims/${id}/approve/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                        location.reload();
                    } else {
                        alert(data.error || 'Error approving claim.');
                    }
                })
                .catch(() => alert('Network error while approving claim.'));
        }

        // Reject claim
        function rejectClaim(id) {
            if (!confirm('Reject this claim?')) return;
            fetch(`/claims/${id}/reject/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                        location.reload();
                    } else {
                        alert(data.error || 'Error rejecting claim.');
                    }
                })
                .catch(() => alert('Network error while rejecting claim.'));
        }

        // Forward claim to admin
        function forwardClaim(id) {
            if (!confirm('Forward this claim to admin?')) return;
            fetch(`/claims/${id}/forward/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                        location.reload();
                    } else {
                        alert(data.error || 'Error forwarding claim.');
                    }
                })
                .catch(() => alert('Network error while forwarding claim.'));
        }

        // Reimburse claim (admin only)
        function reimburseClaim(id) {
            const amount = prompt("Enter reimbursed amount (KES):");
            if (!amount) return;
            fetch(`/claims/${id}/reimburse/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'X-Requested-With': 'XMLHttpRequest',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ amount: amount })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                        location.reload();
                    } else {
                        alert(data.error || 'Error reimbursing claim.');
                    }
                })
                .catch(() => alert('Network error while reimbursing claim.'));
        }

        // CSRF helper
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }



    </script>

</body>

</html>